<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT API æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        select, textarea, button {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .loading {
            text-align: center;
            color: #007cba;
            font-weight: bold;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– GPT API æµ‹è¯•å·¥å…·</h1>
        
        <div class="form-group">
            <label for="modelSelect">é€‰æ‹©GPTæ¨¡å‹ï¼š</label>
            <select id="modelSelect">
                <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
                <option value="gpt-5.2">GPT-5.2</option>
                <option value="gpt-5.1">GPT-5.1</option>
                <option value="gpt-5">GPT-5</option>
                <option value="o4-mini">O4-Mini</option>
                <option value="o1-mini">O1-Mini</option>
            </select>
        </div>

        <div class="form-group">
            <label for="promptInput">æµ‹è¯•æç¤ºè¯ï¼š</label>
            <textarea id="promptInput" placeholder="è¾“å…¥ä½ æƒ³æµ‹è¯•çš„æç¤ºè¯ï¼Œä¾‹å¦‚ï¼šè¯·è¯´ Hello World å¹¶è§£é‡Šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½">è¯·è¯´ Hello World å¹¶è§£é‡Šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½</textarea>
        </div>

        <button id="testButton" onclick="testGPTAPI()">ğŸš€ æµ‹è¯• GPT API</button>
        <button id="configButton" onclick="testConfig()" style="background: #28a745;">ğŸ”§ æµ‹è¯•é…ç½®æ–‡ä»¶</button>

        <div id="result" style="display: none;"></div>
    </div>

    <script>
        // æµ‹è¯•é…ç½®æ–‡ä»¶
        async function testConfig() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">ğŸ” æ­£åœ¨æµ‹è¯•é…ç½®æ–‡ä»¶...</div>';

            try {
                // è¯»å–é…ç½®æ–‡ä»¶
                const response = await fetch('resources/key.txt');
                if (!response.ok) {
                    throw new Error(`é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥: ${response.status}`);
                }
                
                const encryptedData = await response.text();
                console.log('é…ç½®æ–‡ä»¶åŸå§‹æ•°æ®é•¿åº¦:', encryptedData.length);
                
                // è§£å¯†é…ç½®
                const decryptedData = decryptConfig(encryptedData);
                const configs = parseConfigs(decryptedData);
                
                const availableModels = Object.keys(configs);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>âœ… é…ç½®æ–‡ä»¶æµ‹è¯•æˆåŠŸï¼</h3>
                        <p><strong>å¯ç”¨æ¨¡å‹æ•°é‡:</strong> ${availableModels.length}</p>
                        <p><strong>å¯ç”¨æ¨¡å‹:</strong> ${availableModels.join(', ')}</p>
                        <details>
                            <summary>é…ç½®è¯¦æƒ… (ç‚¹å‡»å±•å¼€)</summary>
                            <pre>${JSON.stringify(configs, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
            } catch (error) {
                console.error('é…ç½®æµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ é…ç½®æ–‡ä»¶æµ‹è¯•å¤±è´¥</h3>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p>è¯·æ£€æŸ¥ resources/key.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®</p>
                    </div>
                `;
            }
        }

        // æµ‹è¯•GPT API
        async function testGPTAPI() {
            const model = document.getElementById('modelSelect').value;
            const prompt = document.getElementById('promptInput').value;
            const resultDiv = document.getElementById('result');
            const testButton = document.getElementById('testButton');

            if (!model || !prompt) {
                alert('è¯·é€‰æ‹©æ¨¡å‹å¹¶è¾“å…¥æç¤ºè¯');
                return;
            }

            testButton.disabled = true;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<div class="loading">ğŸ¤– æ­£åœ¨è°ƒç”¨ ${model} æ¨¡å‹...</div>`;

            try {
                console.log(`å¼€å§‹è°ƒç”¨æ¨¡å‹: ${model}`);
                console.log(`æç¤ºè¯: ${prompt}`);
                
                const result = await callGPTModels(prompt, model);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>âœ… GPT API è°ƒç”¨æˆåŠŸï¼</h3>
                        <p><strong>ä½¿ç”¨æ¨¡å‹:</strong> ${model}</p>
                        <p><strong>å“åº”:</strong></p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ GPT API è°ƒç”¨å¤±è´¥</h3>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€APIå¯†é’¥å’Œç«¯ç‚¹é…ç½®</p>
                        <details>
                            <summary>è¯¦ç»†é”™è¯¯ä¿¡æ¯ (ç‚¹å‡»å±•å¼€)</summary>
                            <pre>${error.stack || error.toString()}</pre>
                        </details>
                    </div>
                `;
            } finally {
                testButton.disabled = false;
            }
        }

        // è°ƒç”¨GPTæ¨¡å‹
        async function callGPTModels(prompt, model) {
            try {
                console.log(`æ­£åœ¨è°ƒç”¨æ¨¡å‹: ${model}`);
                
                // è·å–APIé…ç½®
                const config = await getAPIConfig(model);
                console.log('APIé…ç½®è·å–æˆåŠŸ');
                
                const requestBody = {
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: parseInt(config.maxTokens) || 4000,
                    temperature: 0.7
                };

                console.log('è¯·æ±‚ä½“:', requestBody);
                
                const response = await fetch(config.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.apiKey
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('APIå“åº”çŠ¶æ€:', response.status);
                console.log('APIå“åº”å¤´:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}\nè¯¦ç»†ä¿¡æ¯: ${errorText}`);
                }

                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return {
                        model: model,
                        content: data.choices[0].message.content,
                        usage: data.usage || {},
                        raw_response: data
                    };
                } else {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæœªæ‰¾åˆ°é¢„æœŸçš„å“åº”ç»“æ„');
                }
            } catch (error) {
                console.error('GPT APIè°ƒç”¨é”™è¯¯:', error);
                throw error;
            }
        }

        // è·å–APIé…ç½®
        async function getAPIConfig(model) {
            try {
                console.log('æ­£åœ¨è·å–APIé…ç½®...');
                const response = await fetch('resources/key.txt');
                if (!response.ok) {
                    throw new Error(`æ— æ³•è¯»å–é…ç½®æ–‡ä»¶: ${response.status} ${response.statusText}`);
                }
                
                const encryptedData = await response.text();
                console.log('é…ç½®æ–‡ä»¶è¯»å–æˆåŠŸ');
                
                // è§£å¯†é…ç½®æ•°æ®
                const decryptedData = decryptConfig(encryptedData);
                const configs = parseConfigs(decryptedData);
                
                console.log('å¯ç”¨çš„æ¨¡å‹é…ç½®:', Object.keys(configs));
                
                if (!configs[model]) {
                    throw new Error(`æœªæ‰¾åˆ°æ¨¡å‹ ${model} çš„é…ç½®ã€‚å¯ç”¨æ¨¡å‹: ${Object.keys(configs).join(', ')}`);
                }
                
                return configs[model];
            } catch (error) {
                console.error('è·å–APIé…ç½®å¤±è´¥:', error);
                throw new Error(`è·å–APIé…ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // è§£å¯†é…ç½®æ•°æ®
        function decryptConfig(encryptedData) {
            try {
                console.log('å¼€å§‹è§£å¯†é…ç½®...');
                // ç§»é™¤æ³¨é‡Šå’Œç©ºè¡Œ
                const cleanData = encryptedData
                    .split('\n')
                    .filter(line => !line.startsWith('#') && line.trim())
                    .join('');
                
                console.log('æ¸…ç†åçš„æ•°æ®é•¿åº¦:', cleanData.length);
                
                // Base64è§£ç 
                const base64Decoded = atob(cleanData);
                console.log('Base64è§£ç å®Œæˆ');
                
                // å­—ç¬¦åç§»è§£å¯†ï¼ˆåç§»-3ï¼‰
                let decrypted = '';
                for (let i = 0; i < base64Decoded.length; i++) {
                    decrypted += String.fromCharCode(base64Decoded.charCodeAt(i) - 3);
                }
                
                console.log('è§£å¯†å®Œæˆï¼Œæ•°æ®é•¿åº¦:', decrypted.length);
                return decrypted;
            } catch (error) {
                console.error('é…ç½®è§£å¯†å¤±è´¥:', error);
                throw new Error(`é…ç½®è§£å¯†å¤±è´¥: ${error.message}`);
            }
        }

        // è§£æé…ç½®æ•°æ®
        function parseConfigs(configText) {
            try {
                console.log('å¼€å§‹è§£æé…ç½®æ–‡ä»¶...');
                const configs = {};
                const sections = configText.split('[model:').slice(1);
                
                console.log('æ‰¾åˆ°é…ç½®æ®µæ•°:', sections.length);
                
                sections.forEach((section, index) => {
                    console.log(`è§£æç¬¬${index + 1}ä¸ªé…ç½®æ®µ...`);
                    const lines = section.split('\n');
                    const modelName = lines[0].replace(']', '').trim();
                    
                    console.log(`æ¨¡å‹åç§°: ${modelName}`);
                    
                    const config = {};
                    lines.slice(1).forEach(line => {
                        if (line.includes('=')) {
                            const [key, value] = line.split('=').map(s => s.trim());
                            if (key && value) {
                                config[key] = value;
                                // éšè—æ•æ„Ÿä¿¡æ¯
                                const displayValue = key === 'apiKey' ? value.substring(0, 10) + '...' : value.substring(0, 50) + '...';
                                console.log(`  ${key}: ${displayValue}`);
                            }
                        }
                    });
                    
                    if (config.endpoint && config.apiKey) {
                        configs[modelName] = config;
                        console.log(`æ¨¡å‹ ${modelName} é…ç½®è§£ææˆåŠŸ`);
                    } else {
                        console.warn(`æ¨¡å‹ ${modelName} é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡`);
                        console.warn('ç¼ºå°‘:', !config.endpoint ? 'endpoint' : '', !config.apiKey ? 'apiKey' : '');
                    }
                });
                
                console.log('é…ç½®è§£æå®Œæˆï¼Œå¯ç”¨æ¨¡å‹:', Object.keys(configs));
                return configs;
            } catch (error) {
                console.error('é…ç½®è§£æå¤±è´¥:', error);
                throw new Error(`é…ç½®è§£æå¤±è´¥: ${error.message}`);
            }
        }

        console.log('GPT API æµ‹è¯•å·¥å…·åŠ è½½å®Œæˆ');
    </script>
</body>
</html>