<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置文件快速测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>配置文件快速测试</h1>
        
        <button onclick="test1()">测试1: 分析数据</button>
        <button onclick="test2()">测试2: 直接解码</button>
        <button onclick="test3()">测试3: 生成工作配置</button>

        <div id="results"></div>
    </div>

    <script>
        // 实际配置数据
        const configData = `]6E3OWXxPjsrgKUzf}ryO5Q}ep\\wf5ox]6Yv\\[MsgKnw\\Z<kdV4o\\[Q3g[P|Op<z]Z8kdV8khqY|]V8me53ye6EoepIsO6Mof6EyeqQof}<kfJnwgpY|f5oyem3|PGL4OWD3OWD{O[E|][]s][fNPJ\\3]JQm]GD7\\ZMpQGD8]JL3Q}f|QGQpPWP3PJH3QJTNFpgzgF34OmHNdKU3fKP9O|<mf58pO[Qsepg4eJI|d[U8OZIy\\Znw]ZI}gKY}Pl8yfJYx\\Znx\\[s4fpXx\\5<wO5<z]Z8kdV<|][Qze58}][P2\\[EsO[]ofqQse57<PmD|QV3zQF3zPV4zfpY5dZY6FmEpQJUm\\5TzRJIl]mTzRZUlQGf6PmT}]mH}QGEkQGUnFjsqfKTwQTsrgKUzf}ryO5Q}ep\\wf5ox]6Yv\\[MsgKnw\\Z<kdV4o\\[Q3g[P|Op<z]Z8kdV8khqY|]V8me53ye6EoepIsO5UofJ{yhZ4oeqU}O5gzgF34O5Qr\\[Ty\\5<wfJ{ogJoyeqP2\\[EsO[]ofqQse57<PmD|QV3zPV3zPV4zfpY5dZY6FmEpQJUm\\5TzRJIl]mTzRZUlQGf6PmT}]mH}QGEkQGUnFjsyQF4wdZ8sFpk3gKE}Rl;y\\6Qx]l4}dZ8qgZ{kfpo3hV4ke5IsOZYkf6U4f}Lxe6EoepIsOpI9g[MoOpQyeV<yfJYx\\Zny]JYzeJ<8eZYxgKPye}TweZoxdV<mdJI3O5Qye[Ev][Use58}S5IzdV45][M}dZ<xSWLzPmXwPGHwPGHwfKMogpoogzrz]mUn\\5QnPGkk\\p\\3PGon\\mT6Q}L3P5\\{P}Tz\\WT3]DrNe}HweZoxdTsrgKUzf}ryO5Q}ep\\wf5ox]6Yv\\[MsgKnw\\Z<kdV4o\\[Q3g[P|Op<z]Z8kdV8khqY|]V8me53ye6EoepIsO5UofJ{yhZ4oeqU}O5;{OZ4sepny\\5kkgF<me54zeJY3dZ<xf}<kfJnwgpY|f5oyem3|PGL4OWD{OWD{O[E|][]s][f@`;

        function test1() {
            const resultsDiv = document.getElementById('results');
            console.log('开始测试1: 分析数据');
            
            // 基本信息
            const length = configData.length;
            const uniqueChars = [...new Set(configData)].sort();
            const base64Chars = uniqueChars.filter(c => /[A-Za-z0-9+/=]/.test(c));
            const specialChars = uniqueChars.filter(c => !/[A-Za-z0-9+/=]/.test(c));
            
            console.log('数据长度:', length);
            console.log('唯一字符:', uniqueChars.length);
            console.log('特殊字符:', specialChars);
            
            resultsDiv.innerHTML = `
                <div class="result success">
                    <h3>测试1结果: 数据分析</h3>
                    <p><strong>数据长度:</strong> ${length}</p>
                    <p><strong>唯一字符数:</strong> ${uniqueChars.length}</p>
                    <p><strong>Base64字符:</strong> ${base64Chars.length}</p>
                    <p><strong>特殊字符:</strong> ${specialChars.join(', ')}</p>
                    <p><strong>前100字符:</strong></p>
                    <pre>${configData.substring(0, 100)}</pre>
                </div>
            `;
        }

        function test2() {
            const resultsDiv = document.getElementById('results');
            console.log('开始测试2: 直接字符偏移解码');
            
            try {
                // 直接字符偏移-3解码（跳过Base64步骤）
                let decoded = '';
                for (let i = 0; i < configData.length; i++) {
                    decoded += String.fromCharCode(configData.charCodeAt(i) - 3);
                }
                
                console.log('解码成功，长度:', decoded.length);
                console.log('解码结果前200字符:', decoded.substring(0, 200));
                
                // 检查是否包含配置关键词
                const hasModel = decoded.includes('[model:') || decoded.includes('model:');
                const hasEndpoint = decoded.includes('endpoint');
                const hasApiKey = decoded.includes('apiKey') || decoded.includes('api-key');
                
                resultsDiv.innerHTML = `
                    <div class="result ${hasModel && hasEndpoint ? 'success' : 'error'}">
                        <h3>测试2结果: 直接字符偏移解码</h3>
                        <p><strong>解码长度:</strong> ${decoded.length}</p>
                        <p><strong>包含模型配置:</strong> ${hasModel ? '是' : '否'}</p>
                        <p><strong>包含端点:</strong> ${hasEndpoint ? '是' : '否'}</p>
                        <p><strong>包含API密钥:</strong> ${hasApiKey ? '是' : '否'}</p>
                        <p><strong>解码结果:</strong></p>
                        <pre>${decoded}</pre>
                    </div>
                `;
                
                // 如果看起来正确，尝试解析配置
                if (hasModel || hasEndpoint) {
                    parseAndShowConfig(decoded);
                }
                
            } catch (error) {
                console.error('解码失败:', error);
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>测试2结果: 解码失败</h3>
                        <p><strong>错误:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        function parseAndShowConfig(decodedText) {
            try {
                console.log('尝试解析配置...');
                const configs = {};
                
                // 查找模型配置段
                const sections = decodedText.split('[model:').slice(1);
                console.log('找到配置段数:', sections.length);
                
                sections.forEach((section, index) => {
                    console.log(`解析配置段 ${index + 1}:`, section.substring(0, 50));
                    
                    const lines = section.split('\n').filter(line => line.trim());
                    if (lines.length === 0) return;
                    
                    const modelName = lines[0].replace(']', '').trim();
                    console.log('模型名称:', modelName);
                    
                    const config = {};
                    lines.slice(1).forEach(line => {
                        if (line.includes('=')) {
                            const [key, value] = line.split('=').map(s => s.trim());
                            if (key && value) {
                                config[key] = value;
                                console.log(`  ${key}: ${value.substring(0, 30)}...`);
                            }
                        }
                    });
                    
                    if (config.endpoint && config.apiKey) {
                        configs[modelName] = config;
                        console.log(`✓ 模型 ${modelName} 配置成功`);
                    } else {
                        console.log(`✗ 模型 ${modelName} 配置不完整`);
                    }
                });
                
                // 显示解析结果
                const modelCount = Object.keys(configs).length;
                const additionalInfo = document.createElement('div');
                additionalInfo.innerHTML = `
                    <div class="result ${modelCount > 0 ? 'success' : 'error'}" style="margin-top: 20px;">
                        <h3>配置解析结果</h3>
                        <p><strong>成功解析模型数:</strong> ${modelCount}</p>
                        <p><strong>可用模型:</strong> ${Object.keys(configs).join(', ') || '无'}</p>
                        ${modelCount > 0 ? `<pre>${JSON.stringify(configs, (k, v) => k === 'apiKey' ? v.substring(0, 10) + '...' : v, 2)}</pre>` : ''}
                    </div>
                `;
                document.getElementById('results').appendChild(additionalInfo);
                
                if (modelCount > 0) {
                    window.workingConfigs = configs;
                    console.log('✓ 配置解析成功！', configs);
                }
                
            } catch (error) {
                console.error('配置解析失败:', error);
            }
        }

        function test3() {
            const resultsDiv = document.getElementById('results');
            
            // 检查是否有工作配置
            if (window.workingConfigs) {
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>测试3结果: 使用解析的配置</h3>
                        <p>已发现可用配置！</p>
                        <p><strong>可用模型:</strong> ${Object.keys(window.workingConfigs).join(', ')}</p>
                        <button onclick="testAPICall()">测试API调用</button>
                    </div>
                `;
            } else {
                // 生成测试配置
                const testConfig = {
                    'gpt-test': {
                        endpoint: 'https://test.openai.azure.com/openai/deployments/gpt-test/chat/completions?api-version=2023-12-01-preview',
                        apiKey: 'test-key-123',
                        maxTokens: '4000'
                    }
                };
                
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>测试3结果: 生成测试配置</h3>
                        <p>未找到有效配置，生成测试配置:</p>
                        <pre>${JSON.stringify(testConfig, null, 2)}</pre>
                        <p><em>注意：这是测试配置，实际调用会失败</em></p>
                    </div>
                `;
            }
        }

        async function testAPICall() {
            if (!window.workingConfigs) {
                alert('没有可用配置');
                return;
            }
            
            const modelName = Object.keys(window.workingConfigs)[0];
            const config = window.workingConfigs[modelName];
            
            console.log(`测试API调用: ${modelName}`);
            
            try {
                const response = await fetch(config.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.apiKey
                    },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: 'Hello, test message' }],
                        max_tokens: 100
                    })
                });
                
                console.log('API响应状态:', response.status);
                const result = await response.text();
                console.log('API响应:', result);
                
                alert(`API调用测试完成\n状态: ${response.status}\n详情请查看控制台`);
                
            } catch (error) {
                console.error('API调用失败:', error);
                alert(`API调用失败: ${error.message}`);
            }
        }

        console.log('配置测试工具加载完成');
    </script>
</body>
</html>